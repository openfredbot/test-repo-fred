<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stake $FRED ü¶ä | 30% APY</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #ff6b35;
            --primary-dark: #e55a2b;
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-input: #1a1a24;
            --text: #ffffff;
            --text-muted: #8892b0;
            --accent: #64ffda;
            --success: #4ade80;
            --warning: #fbbf24;
            --gradient: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }
        
        .bg-animation {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 20% 80%, rgba(255, 107, 53, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(100, 255, 218, 0.05) 0%, transparent 50%);
        }
        
        nav {
            padding: 1.5rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .network-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(100, 255, 218, 0.1);
            border-radius: 50px;
            font-size: 0.85rem;
            color: var(--accent);
        }
        
        .network-badge.wrong {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .network-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .network-badge.wrong .network-dot {
            background: #ef4444;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .connect-btn {
            padding: 0.75rem 1.5rem;
            background: var(--gradient);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }
        
        .connect-btn.connected {
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .wallet-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gradient);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 5%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .header h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .header .apy-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(100, 255, 218, 0.1);
            border: 1px solid var(--accent);
            border-radius: 50px;
            color: var(--accent);
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.75rem;
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid var(--success);
            border-radius: 50px;
            color: var(--success);
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            border-color: rgba(255, 107, 53, 0.3);
            transform: translateY(-2px);
        }
        
        .stat-card .label {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 1.75rem;
            font-weight: 700;
        }
        
        .stat-card .value.accent { color: var(--accent); }
        .stat-card .value.primary { color: var(--primary); }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }
        
        .card {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-group label {
            display: block;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .input-wrapper {
            display: flex;
            background: var(--bg-input);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            transition: border-color 0.3s;
        }
        
        .input-wrapper:focus-within {
            border-color: var(--primary);
        }
        
        .input-wrapper input {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1.1rem;
            outline: none;
        }
        
        .input-wrapper .max-btn {
            padding: 0 1rem;
            background: transparent;
            border: none;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .input-wrapper .max-btn:hover {
            opacity: 0.8;
        }
        
        .balance-row {
            display: flex;
            justify-content: space-between;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }
        
        .action-btn {
            width: 100%;
            padding: 1rem;
            background: var(--gradient);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .action-btn.secondary {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .action-btn.loading {
            pointer-events: none;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .rewards-card {
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.1) 0%, rgba(255, 107, 53, 0.1) 100%);
            border: 1px solid rgba(100, 255, 218, 0.3);
        }
        
        .rewards-amount {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
            text-align: center;
            margin: 1.5rem 0;
            font-family: monospace;
        }
        
        .rewards-usd {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .info-row:last-child { border: none; }
        .info-row .label { color: var(--text-muted); }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: modalIn 0.3s ease;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal h3 {
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .wallet-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-input);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.75rem;
            border: 1px solid transparent;
        }
        
        .wallet-option:hover {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.1);
        }
        
        .wallet-option img {
            width: 40px;
            height: 40px;
            border-radius: 10px;
        }
        
        .wallet-option .wallet-name {
            font-weight: 600;
        }
        
        .wallet-option .wallet-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .modal-close {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--text-muted);
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            border-color: var(--text-muted);
        }
        
        /* Not Connected State */
        .not-connected {
            text-align: center;
            padding: 3rem;
        }
        
        .not-connected .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .not-connected h2 {
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .not-connected p {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }
        
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
            z-index: 1000;
            max-width: 350px;
        }
        
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: #ef4444; }
        .toast.show { display: flex; align-items: center; gap: 0.75rem; animation: slideIn 0.3s ease; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        footer {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        footer a { color: var(--primary); text-decoration: none; }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .main-grid { grid-template-columns: 1fr; }
            .nav-right { gap: 0.5rem; }
            .network-badge span:last-child { display: none; }
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <nav>
        <a href="index.html" class="logo">ü¶ä Fred Staking</a>
        <div class="nav-right">
            <div class="network-badge" id="networkBadge">
                <div class="network-dot"></div>
                <span>Base</span>
            </div>
            <button class="connect-btn" id="connectBtn" onclick="openConnectModal()">
                üîó Conectar
            </button>
        </div>
    </nav>
    
    <div class="container">
        <div class="header">
            <h1>Stake $FRED</h1>
            <p style="color: var(--text-muted);">Ganhe recompensas passivas com seu $FRED</p>
            <div class="apy-badge">
                <span>üî•</span>
                <span>30% APY</span>
            </div>
            <span class="verified-badge">‚úì Verificado</span>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">Total Staked</div>
                <div class="value" id="totalStaked">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Reward Pool</div>
                <div class="value accent" id="rewardPool">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Your Stake</div>
                <div class="value primary" id="yourStake">-</div>
            </div>
            <div class="stat-card">
                <div class="label">APY</div>
                <div class="value accent">30%</div>
            </div>
        </div>
        
        <!-- Not Connected State -->
        <div class="card not-connected" id="notConnectedCard">
            <div class="icon">ü¶ä</div>
            <h2>Conecte sua Wallet</h2>
            <p>Conecte sua wallet para fazer stake de $FRED e ganhar recompensas</p>
            <button class="action-btn" onclick="openConnectModal()" style="max-width: 300px; margin: 0 auto;">
                üîó Conectar Wallet
            </button>
        </div>
        
        <!-- Connected State -->
        <div class="main-grid hidden" id="stakingPanel">
            <div class="card">
                <h2>üì• Stake</h2>
                <div class="input-group">
                    <label>Quantidade</label>
                    <div class="input-wrapper">
                        <input type="number" id="stakeAmount" placeholder="0.0">
                        <button class="max-btn" onclick="setMaxStake()">MAX</button>
                    </div>
                </div>
                <div class="balance-row">
                    <span>Balance:</span>
                    <span id="walletBalance">0 FRED</span>
                </div>
                <button class="action-btn" id="stakeBtn" onclick="stakeTokens()">
                    Stake $FRED
                </button>
            </div>
            
            <div class="card">
                <h2>üì§ Unstake</h2>
                <div class="input-group">
                    <label>Quantidade</label>
                    <div class="input-wrapper">
                        <input type="number" id="unstakeAmount" placeholder="0.0">
                        <button class="max-btn" onclick="setMaxUnstake()">MAX</button>
                    </div>
                </div>
                <div class="balance-row">
                    <span>Staked:</span>
                    <span id="stakedBalance">0 FRED</span>
                </div>
                <button class="action-btn secondary" id="unstakeBtn" onclick="unstakeTokens()">
                    Unstake $FRED
                </button>
            </div>
            
            <div class="card rewards-card">
                <h2>üéÅ Rewards</h2>
                <div class="rewards-amount" id="pendingRewards">0.0000</div>
                <div class="rewards-usd">$FRED acumulado</div>
                <button class="action-btn" id="claimBtn" onclick="claimRewards()">
                    Claim Rewards
                </button>
                
                <div style="margin-top: 2rem;">
                    <div class="info-row">
                        <span class="label">Taxa de recompensa</span>
                        <span>~0.082% / dia</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Tempo m√≠nimo</span>
                        <span>Sem lock ‚úÖ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Contrato: <a href="https://basescan.org/address/0xA31824476d177205d448908a4ec9f6e2fc9274DB" target="_blank">0xA314...4DB</a> ‚Ä¢ <a href="admin.html">Admin</a></p>
        <p style="margin-top: 0.5rem;">Powered by <a href="index.html">Open Fred</a> ü¶ä</p>
    </footer>
    
    <!-- Connect Modal -->
    <div class="modal-overlay" id="connectModal">
        <div class="modal">
            <h3>Conectar Wallet</h3>
            
            <div class="wallet-option" onclick="connectWallet('metamask')">
                <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask">
                <div>
                    <div class="wallet-name">MetaMask</div>
                    <div class="wallet-desc">Conectar com MetaMask</div>
                </div>
            </div>
            
            <div class="wallet-option" onclick="connectWallet('walletconnect')">
                <img src="https://avatars.githubusercontent.com/u/37784886" alt="WalletConnect" style="background: #3B99FC;">
                <div>
                    <div class="wallet-name">WalletConnect</div>
                    <div class="wallet-desc">Escanear com seu celular</div>
                </div>
            </div>
            
            <div class="wallet-option" onclick="connectWallet('coinbase')">
                <img src="https://avatars.githubusercontent.com/u/18060234" alt="Coinbase">
                <div>
                    <div class="wallet-name">Coinbase Wallet</div>
                    <div class="wallet-desc">Conectar com Coinbase</div>
                </div>
            </div>
            
            <button class="modal-close" onclick="closeConnectModal()">Cancelar</button>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        const STAKING_CONTRACT = '0xA31824476d177205d448908a4ec9f6e2fc9274DB';
        const FRED_TOKEN = '0x3f9BEB72028F52111065c9e9F8684B91Ad19dE9d';
        const BASE_CHAIN_ID = 8453;
        
        const STAKING_ABI = [
            "function stake(uint256 amount) external",
            "function unstake(uint256 amount) external",
            "function claimRewards() external",
            "function pendingRewards(address user) view returns (uint256)",
            "function getStakeInfo(address user) view returns (uint256 stakedAmount, uint256 pending, uint256 lastUpdate)",
            "function getContractStats() view returns (uint256 totalStaked, uint256 rewardPool, uint256 totalRewardsPaid, uint256 apy)"
        ];
        
        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];
        
        let provider, signer, userAddress;
        let stakingContract, tokenContract;
        let rewardUpdateInterval;
        
        function openConnectModal() {
            document.getElementById('connectModal').classList.add('show');
        }
        
        function closeConnectModal() {
            document.getElementById('connectModal').classList.remove('show');
        }
        
        async function connectWallet(walletType) {
            closeConnectModal();
            
            if (walletType === 'walletconnect' || walletType === 'coinbase') {
                showToast('Em breve! Use MetaMask por enquanto.', 'error');
                return;
            }
            
            if (!window.ethereum) {
                showToast('MetaMask n√£o encontrado! Instale em metamask.io', 'error');
                return;
            }
            
            try {
                showToast('Conectando...', 'success');
                
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0];
                
                // Check and switch network
                const network = await provider.getNetwork();
                if (Number(network.chainId) !== BASE_CHAIN_ID) {
                    showToast('Mudando para Base...', 'success');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x2105' }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x2105',
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                    provider = new ethers.BrowserProvider(window.ethereum);
                }
                
                signer = await provider.getSigner();
                
                // Initialize contracts
                stakingContract = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
                tokenContract = new ethers.Contract(FRED_TOKEN, ERC20_ABI, signer);
                
                // Update UI
                const shortAddr = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                document.getElementById('connectBtn').innerHTML = `
                    <div class="wallet-avatar"></div>
                    ${shortAddr}
                `;
                document.getElementById('connectBtn').classList.add('connected');
                document.getElementById('connectBtn').onclick = disconnectWallet;
                
                document.getElementById('notConnectedCard').classList.add('hidden');
                document.getElementById('stakingPanel').classList.remove('hidden');
                
                await updateAllData();
                
                // Start reward updater
                rewardUpdateInterval = setInterval(updatePendingRewards, 3000);
                
                showToast('‚úì Wallet conectada com sucesso!', 'success');
                
            } catch (error) {
                console.error(error);
                if (error.code === 4001) {
                    showToast('Conex√£o cancelada pelo usu√°rio', 'error');
                } else {
                    showToast('Erro: ' + (error.message || 'Falha na conex√£o'), 'error');
                }
            }
        }
        
        function disconnectWallet() {
            userAddress = null;
            provider = null;
            signer = null;
            stakingContract = null;
            tokenContract = null;
            
            if (rewardUpdateInterval) clearInterval(rewardUpdateInterval);
            
            document.getElementById('connectBtn').innerHTML = 'üîó Conectar';
            document.getElementById('connectBtn').classList.remove('connected');
            document.getElementById('connectBtn').onclick = openConnectModal;
            
            document.getElementById('notConnectedCard').classList.remove('hidden');
            document.getElementById('stakingPanel').classList.add('hidden');
            
            showToast('Wallet desconectada', 'success');
        }
        
        async function updateAllData() {
            if (!userAddress) return;
            
            try {
                const [balance, stakeInfo, stats] = await Promise.all([
                    tokenContract.balanceOf(userAddress),
                    stakingContract.getStakeInfo(userAddress),
                    stakingContract.getContractStats()
                ]);
                
                document.getElementById('walletBalance').textContent = formatAmount(balance) + ' FRED';
                document.getElementById('yourStake').textContent = formatAmount(stakeInfo[0]) + ' FRED';
                document.getElementById('stakedBalance').textContent = formatAmount(stakeInfo[0]) + ' FRED';
                document.getElementById('pendingRewards').textContent = formatAmount(stakeInfo[1]);
                document.getElementById('totalStaked').textContent = formatAmount(stats[0]) + ' FRED';
                document.getElementById('rewardPool').textContent = formatAmount(stats[1]) + ' FRED';
                
            } catch (error) {
                console.error('Error updating data:', error);
            }
        }
        
        async function updatePendingRewards() {
            if (!userAddress || !stakingContract) return;
            try {
                const pending = await stakingContract.pendingRewards(userAddress);
                document.getElementById('pendingRewards').textContent = formatAmount(pending);
            } catch (e) {}
        }
        
        function formatAmount(wei) {
            const value = parseFloat(ethers.formatEther(wei));
            if (value === 0) return '0.00';
            if (value < 0.0001) return value.toExponential(2);
            return value.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 4
            });
        }
        
        async function setMaxStake() {
            if (!tokenContract || !userAddress) return;
            const balance = await tokenContract.balanceOf(userAddress);
            document.getElementById('stakeAmount').value = ethers.formatEther(balance);
        }
        
        async function setMaxUnstake() {
            if (!stakingContract || !userAddress) return;
            const stakeInfo = await stakingContract.getStakeInfo(userAddress);
            document.getElementById('unstakeAmount').value = ethers.formatEther(stakeInfo[0]);
        }
        
        async function stakeTokens() {
            const amount = document.getElementById('stakeAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                showToast('Digite uma quantidade v√°lida', 'error');
                return;
            }
            
            const btn = document.getElementById('stakeBtn');
            btn.innerHTML = '<div class="spinner"></div> Processando...';
            btn.classList.add('loading');
            
            try {
                const amountWei = ethers.parseEther(amount);
                
                const allowance = await tokenContract.allowance(userAddress, STAKING_CONTRACT);
                if (allowance < amountWei) {
                    showToast('Aprovando tokens... Confirme na wallet', 'success');
                    const approveTx = await tokenContract.approve(STAKING_CONTRACT, ethers.MaxUint256);
                    await approveTx.wait();
                }
                
                showToast('Fazendo stake... Confirme na wallet', 'success');
                const tx = await stakingContract.stake(amountWei);
                await tx.wait();
                
                showToast('‚úì Stake realizado com sucesso!', 'success');
                document.getElementById('stakeAmount').value = '';
                await updateAllData();
                
            } catch (error) {
                console.error(error);
                if (error.code === 4001 || error.code === 'ACTION_REJECTED') {
                    showToast('Transa√ß√£o cancelada', 'error');
                } else {
                    showToast('Erro: ' + (error.reason || error.message), 'error');
                }
            } finally {
                btn.innerHTML = 'Stake $FRED';
                btn.classList.remove('loading');
            }
        }
        
        async function unstakeTokens() {
            const amount = document.getElementById('unstakeAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                showToast('Digite uma quantidade v√°lida', 'error');
                return;
            }
            
            const btn = document.getElementById('unstakeBtn');
            btn.innerHTML = '<div class="spinner"></div> Processando...';
            btn.classList.add('loading');
            
            try {
                const amountWei = ethers.parseEther(amount);
                
                showToast('Fazendo unstake... Confirme na wallet', 'success');
                const tx = await stakingContract.unstake(amountWei);
                await tx.wait();
                
                showToast('‚úì Unstake realizado com sucesso!', 'success');
                document.getElementById('unstakeAmount').value = '';
                await updateAllData();
                
            } catch (error) {
                console.error(error);
                if (error.code === 4001 || error.code === 'ACTION_REJECTED') {
                    showToast('Transa√ß√£o cancelada', 'error');
                } else {
                    showToast('Erro: ' + (error.reason || error.message), 'error');
                }
            } finally {
                btn.innerHTML = 'Unstake $FRED';
                btn.classList.remove('loading');
            }
        }
        
        async function claimRewards() {
            const btn = document.getElementById('claimBtn');
            btn.innerHTML = '<div class="spinner"></div> Processando...';
            btn.classList.add('loading');
            
            try {
                showToast('Coletando recompensas... Confirme na wallet', 'success');
                const tx = await stakingContract.claimRewards();
                await tx.wait();
                
                showToast('‚úì Recompensas coletadas!', 'success');
                await updateAllData();
                
            } catch (error) {
                console.error(error);
                if (error.code === 4001 || error.code === 'ACTION_REJECTED') {
                    showToast('Transa√ß√£o cancelada', 'error');
                } else {
                    showToast('Erro: ' + (error.reason || error.message), 'error');
                }
            } finally {
                btn.innerHTML = 'Claim Rewards';
                btn.classList.remove('loading');
            }
        }
        
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            const icon = type === 'success' ? '‚úì' : '‚úï';
            toast.innerHTML = `<span style="font-size: 1.2rem;">${icon}</span> ${message}`;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 4000);
        }
        
        // Load contract stats on page load
        async function loadPublicStats() {
            try {
                const rpcProvider = new ethers.JsonRpcProvider('https://mainnet.base.org');
                const contract = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, rpcProvider);
                const stats = await contract.getContractStats();
                
                document.getElementById('totalStaked').textContent = formatAmount(stats[0]) + ' FRED';
                document.getElementById('rewardPool').textContent = formatAmount(stats[1]) + ' FRED';
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }
        
        // Event listeners
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    location.reload();
                }
            });
            window.ethereum.on('chainChanged', () => location.reload());
        }
        
        // Close modal on outside click
        document.getElementById('connectModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('connectModal')) {
                closeConnectModal();
            }
        });
        
        // Load stats on page load
        loadPublicStats();
    </script>
</body>
</html>
